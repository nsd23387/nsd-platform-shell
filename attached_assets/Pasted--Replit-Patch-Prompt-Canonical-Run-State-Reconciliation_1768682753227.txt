ğŸ”§ Replit Patch Prompt â€” Canonical Run State Reconciliation (P0)

Objective
Fix the Campaign Detail UI so it tells an accurate, transparent story that strictly reflects the authoritative execution state from campaign_runs.

The UI must never imply that a campaign is running, queued, or being cleaned up when no such run exists in the database.

ğŸš¨ Problem Statement

The UI currently displays misleading states such as:

â€œQueued â€” execution will start shortlyâ€

â€œPrevious execution is being cleaned upâ€

â€œAwaiting system cleanupâ€

Even when all runs in public.campaign_runs are terminal (failed).

This occurs because the UI:

Over-weights historical ODS / activity events

Does not reconcile them against the authoritative campaign_runs.status

This violates the execution contract:

campaign_runs is canonical

ODS events are descriptive only

âœ… Required Behavioral Rules (Must Enforce)

Single Source of Truth

campaign_runs.status is authoritative for execution state

ODS events may provide context, but NEVER override run status

No Active Run Means No Execution UI
If the most recent run has status:

failed

completed

skipped

Then the UI MUST:

Show â€œNo active executionâ€

Show last run outcome (e.g. â€œLast run failed on Jan 17â€)

NOT show:

Queued

Running

Cleaning up

Awaiting system cleanup

Stale Messaging Guardrail
â€œStale / being cleaned upâ€ messaging is ONLY allowed if:

campaign_runs.status = 'running'

AND now() - started_at > 30 minutes

If status â‰  running, stale messaging is forbidden.

Queued Messaging Guardrail
â€œQueued â€” execution will start shortlyâ€ is ONLY allowed if:

campaign_runs.status = 'queued'

Never infer queued state from events.

ğŸ› ï¸ Implementation Requirements
1. Centralize Canonical Run Resolution

Create or update a single helper (if not already present):

resolveCanonicalRunState(run)


This function must:

Take the latest campaign_runs row

Return a normalized state:

idle

queued

running

failed

completed

skipped

No component may compute execution state independently.

2. Update UI Components to Respect Canonical State

Update the following components to rely ONLY on canonical state:

ExecutionStatusCard

LatestRunStatus

ExecutionSummary

ExecutionTimeline

ExecutionHealthIndicator

ActiveStageFocusPanel

Explicitly remove logic that:

Infers state from ODS events alone

Shows â€œcleanupâ€ when no running run exists

3. Correct Messaging Matrix (Mandatory)
Canonical Status	UI Message
failed	â€œLast execution failedâ€
completed	â€œLast execution completed successfullyâ€
skipped	â€œExecution skipped (planning only)â€
none / no runs	â€œNo execution has run yetâ€
queued	â€œExecution queuedâ€
running (<30m)	â€œExecution in progressâ€
running (>30m)	â€œExecution stalled â€” system will mark failedâ€

No other combinations are allowed.

ğŸ§ª Verification Steps (Must Pass)

After implementation, verify using this scenario:

Given

SELECT status FROM public.campaign_runs;
-- returns only 'failed'


Then the UI must show

No queued state

No cleanup state

No running indicators

Clear message: â€œLast execution failedâ€

â›” Explicit Non-Goals

Do NOT modify backend execution logic

Do NOT add retries or resurrection logic

Do NOT change schema

Do NOT suppress historical run visibility

Do NOT infer future execution from past events

âœ… Completion Criteria

State explicitly when done:

â€œThe Campaign Detail UI now reflects canonical execution state exclusively from campaign_runs. No stale, queued, or cleanup messaging appears unless an active run truly exists.â€